-- ============================================================================
-- Enterprise HR Portal - Production Schema
-- Database: PostgreSQL with Supabase
-- Date: 2025-12-19
-- ============================================================================

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Enable pgcrypto for encryption
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- ============================================================================
-- ENUMS
-- ============================================================================

CREATE TYPE approval_status AS ENUM (
  'pending',
  'approved',
  'rejected',
  'withdrawn'
);

CREATE TYPE epf_status AS ENUM (
  'Mandatory',
  'Voluntary'
);

CREATE TYPE ewa_request_status AS ENUM (
  'pending',
  'approved',
  'rejected',
  'cancelled',
  'processed'
);

CREATE TYPE payroll_status AS ENUM (
  'draft',
  'locked',
  'processed',
  'paid',
  'cancelled'
);

-- ============================================================================
-- TENANTS & ORGANIZATION
-- ============================================================================

CREATE TABLE tenants (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL UNIQUE,
  slug VARCHAR(100) NOT NULL UNIQUE,
  description TEXT,
  logo_url TEXT,
  contact_email VARCHAR(255),
  contact_phone VARCHAR(20),
  address JSONB,
  industry VARCHAR(100),
  employee_count INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tenants_slug ON tenants(slug);

-- ============================================================================
-- EMPLOYEE MASTER
-- ============================================================================

CREATE TABLE employee_master (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  
  -- Basic Information
  employee_id VARCHAR(50) NOT NULL,
  full_name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL,
  
  -- Sensitive Data (Encrypted)
  nric BYTEA,  -- National Registration Identity Card (Encrypted)
  phone_number VARCHAR(20),  -- Indexed for WhatsApp lookups
  
  -- Employment Details
  department VARCHAR(100),
  designation VARCHAR(100),
  employment_type VARCHAR(50),  -- 'Full-time', 'Contract', 'Part-time', etc.
  date_of_joining DATE,
  date_of_birth DATE,
  
  -- EPF Configuration
  epf_status epf_status DEFAULT 'Mandatory',
  epf_member_number VARCHAR(50),
  
  -- Approval Chain
  approval_chain UUID[] DEFAULT ARRAY[]::UUID[],  -- Array of approver UUIDs
  
  -- Status & Flags
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT employee_unique_per_tenant UNIQUE(tenant_id, employee_id)
);

CREATE INDEX idx_employee_tenant_id ON employee_master(tenant_id);
CREATE INDEX idx_employee_email ON employee_master(email);
CREATE INDEX idx_employee_phone_number ON employee_master(phone_number);  -- For WhatsApp lookups
CREATE INDEX idx_employee_is_active ON employee_master(is_active);
CREATE INDEX idx_employee_approval_chain ON employee_master USING GIN(approval_chain);

-- ============================================================================
-- SALARY CONFIGURATION
-- ============================================================================

CREATE TABLE salary_config (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  employee_id UUID NOT NULL REFERENCES employee_master(id) ON DELETE CASCADE,
  
  -- Salary Components
  basic_salary NUMERIC(12, 2) NOT NULL DEFAULT 0,
  daily_rate NUMERIC(12, 2),  -- Calculated as basic_salary / 26
  hourly_rate NUMERIC(12, 2),  -- Calculated as basic_salary / 26 / 8
  
  -- Personal Tax Information
  marital_status VARCHAR(20) DEFAULT 'single',  -- 'single', 'married', 'widowed'
  children INTEGER DEFAULT 0,
  is_foreigner BOOLEAN DEFAULT false,
  tax_category VARCHAR(2) DEFAULT 'B',  -- PCB Category: B, C, D, E, F, G, H, I, J
  
  -- Overtime Configuration
  ot_rate_multiplier NUMERIC(5, 2) DEFAULT 1.5,  -- Standard 1.5x for OT
  
  -- EWA Limits
  monthly_ewa_limit NUMERIC(12, 2) DEFAULT 5000,
  
  -- Status & Validity
  is_active BOOLEAN DEFAULT true,
  effective_date DATE NOT NULL,
  end_date DATE,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT salary_config_unique_employee UNIQUE(employee_id, effective_date)
);

CREATE INDEX idx_salary_config_tenant_id ON salary_config(tenant_id);
CREATE INDEX idx_salary_config_employee_id ON salary_config(employee_id);
CREATE INDEX idx_salary_config_is_active ON salary_config(is_active);
CREATE INDEX idx_salary_config_effective_date ON salary_config(effective_date);

-- Trigger to update daily_rate and hourly_rate automatically
CREATE OR REPLACE FUNCTION update_salary_rates()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.basic_salary IS NOT NULL AND NEW.basic_salary > 0 THEN
    NEW.daily_rate := ROUND(NEW.basic_salary / 26, 2);
    NEW.hourly_rate := ROUND(NEW.basic_salary / 26 / 8, 2);
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER salary_config_calculate_rates
BEFORE INSERT OR UPDATE ON salary_config
FOR EACH ROW
EXECUTE FUNCTION update_salary_rates();

-- ============================================================================
-- ATTENDANCE LEDGER
-- ============================================================================

CREATE TABLE attendance_ledger (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  employee_id UUID NOT NULL REFERENCES employee_master(id) ON DELETE CASCADE,
  
  -- Clock In/Out Timestamps
  attendance_date DATE NOT NULL,
  raw_clock_in TIMESTAMP WITH TIME ZONE,  -- Immutable - original timestamp
  verified_clock_in TIMESTAMP WITH TIME ZONE,  -- Editable - corrected timestamp
  raw_clock_out TIMESTAMP WITH TIME ZONE,  -- Immutable - original timestamp
  verified_clock_out TIMESTAMP WITH TIME ZONE,  -- Editable - corrected timestamp
  
  -- Duration Tracking
  working_hours NUMERIC(5, 2),  -- Calculated from verified times
  
  -- Overtime Tracking
  ot_requested_hours NUMERIC(5, 2),
  ot_approved_hours NUMERIC(5, 2),
  ot_approval_status approval_status DEFAULT 'pending',
  
  -- Additional Fields
  remarks TEXT,
  is_manual_entry BOOLEAN DEFAULT false,
  manual_entry_by UUID REFERENCES employee_master(id),
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_attendance_tenant_id ON attendance_ledger(tenant_id);
CREATE INDEX idx_attendance_employee_id ON attendance_ledger(employee_id);
CREATE INDEX idx_attendance_date ON attendance_ledger(attendance_date);
CREATE INDEX idx_attendance_employee_date ON attendance_ledger(employee_id, attendance_date);
CREATE INDEX idx_attendance_ot_status ON attendance_ledger(ot_approval_status);

-- ============================================================================
-- EARNED WAGE ACCESS (EWA)
-- ============================================================================

CREATE TABLE ewa_transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  employee_id UUID NOT NULL REFERENCES employee_master(id) ON DELETE CASCADE,
  
  -- Request Details
  request_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
  requested_amount NUMERIC(12, 2) NOT NULL,
  approved_amount NUMERIC(12, 2),
  
  -- Limits & Safety
  safe_limit_snapshot NUMERIC(12, 2) NOT NULL,  -- Safe limit at time of request
  monthly_limit NUMERIC(12, 2) NOT NULL,
  ytd_amount_withdrawn NUMERIC(12, 2),
  
  -- Status Tracking
  status ewa_request_status DEFAULT 'pending',
  approval_date TIMESTAMP WITH TIME ZONE,
  processing_date TIMESTAMP WITH TIME ZONE,
  rejected_reason TEXT,
  
  -- Settlement Details
  settlement_date TIMESTAMP WITH TIME ZONE,
  settlement_method VARCHAR(50),  -- 'bank_transfer', 'cash', etc.
  transaction_reference VARCHAR(100),
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_ewa_tenant_id ON ewa_transactions(tenant_id);
CREATE INDEX idx_ewa_employee_id ON ewa_transactions(employee_id);
CREATE INDEX idx_ewa_request_date ON ewa_transactions(request_date);
CREATE INDEX idx_ewa_status ON ewa_transactions(status);
CREATE INDEX idx_ewa_employee_status ON ewa_transactions(employee_id, status);

-- ============================================================================
-- PAYROLL ENGINE
-- ============================================================================

-- Payroll Run Configuration
CREATE TABLE payroll_runs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  
  -- Run Configuration
  payroll_month DATE NOT NULL,  -- First day of the month
  run_date TIMESTAMP WITH TIME ZONE NOT NULL,
  
  -- Split Cycle Configuration
  basic_start_date DATE NOT NULL,  -- Start date for basic salary cycle
  basic_end_date DATE NOT NULL,
  ot_start_date DATE NOT NULL,  -- Start date for overtime cycle
  ot_end_date DATE NOT NULL,
  
  -- Status & Metadata
  status payroll_status DEFAULT 'draft',
  processed_by UUID REFERENCES employee_master(id),
  processed_date TIMESTAMP WITH TIME ZONE,
  
  -- Summary Totals
  total_employees INTEGER,
  total_gross_amount NUMERIC(15, 2),
  total_deductions NUMERIC(15, 2),
  total_net_amount NUMERIC(15, 2),
  
  remarks TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT payroll_unique_per_tenant UNIQUE(tenant_id, payroll_month)
);

CREATE INDEX idx_payroll_runs_tenant_id ON payroll_runs(tenant_id);
CREATE INDEX idx_payroll_runs_month ON payroll_runs(payroll_month);
CREATE INDEX idx_payroll_runs_status ON payroll_runs(status);

-- Payroll Items (Final Calculated Values)
CREATE TABLE payroll_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  payroll_run_id UUID NOT NULL REFERENCES payroll_runs(id) ON DELETE CASCADE,
  employee_id UUID NOT NULL REFERENCES employee_master(id) ON DELETE CASCADE,
  
  -- Earnings
  basic_salary NUMERIC(12, 2) NOT NULL DEFAULT 0,
  allowances NUMERIC(12, 2) DEFAULT 0,
  overtime_hours NUMERIC(5, 2) DEFAULT 0,
  overtime_amount NUMERIC(12, 2) DEFAULT 0,
  bonus NUMERIC(12, 2) DEFAULT 0,
  other_earnings NUMERIC(12, 2) DEFAULT 0,
  
  gross_amount NUMERIC(12, 2) NOT NULL DEFAULT 0,
  
  -- Deductions
  epf_employee NUMERIC(12, 2) DEFAULT 0,
  socso NUMERIC(12, 2) DEFAULT 0,
  pcb_tax NUMERIC(12, 2) DEFAULT 0,
  ewa_deductions NUMERIC(12, 2) DEFAULT 0,
  loan_deductions NUMERIC(12, 2) DEFAULT 0,
  other_deductions NUMERIC(12, 2) DEFAULT 0,
  
  total_deductions NUMERIC(12, 2) NOT NULL DEFAULT 0,
  
  -- Net Amount
  net_amount NUMERIC(12, 2) NOT NULL DEFAULT 0,
  
  -- Payment Details
  payment_status VARCHAR(50) DEFAULT 'pending',  -- 'pending', 'processed', 'failed'
  payment_date TIMESTAMP WITH TIME ZONE,
  payment_method VARCHAR(50),  -- 'bank_transfer', 'cash', etc.
  bank_reference VARCHAR(100),
  
  -- Audit Trail
  calculated_by UUID REFERENCES employee_master(id),
  calculated_date TIMESTAMP WITH TIME ZONE,
  approved_by UUID REFERENCES employee_master(id),
  approved_date TIMESTAMP WITH TIME ZONE,
  
  remarks TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_payroll_items_tenant_id ON payroll_items(tenant_id);
CREATE INDEX idx_payroll_items_payroll_run_id ON payroll_items(payroll_run_id);
CREATE INDEX idx_payroll_items_employee_id ON payroll_items(employee_id);
CREATE INDEX idx_payroll_items_payment_status ON payroll_items(payment_status);

-- ============================================================================
-- STATUTORY CONFIGURATION
-- ============================================================================

CREATE TABLE statutory_config (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  
  -- Configuration Name & Version
  config_name VARCHAR(100) NOT NULL,
  version VARCHAR(20) DEFAULT '1.0',
  effective_date DATE NOT NULL,
  end_date DATE,
  
  -- PCB Tax Tables (JSON)
  pcb_tax_table JSONB,  -- Stores tax brackets and rates
  
  -- EPF Rules (JSON)
  epf_rules JSONB,  -- Stores EPF calculation rules
  
  -- SOCSO Configuration (JSON)
  socso_rates JSONB,
  
  -- Other Statutory Rules (JSON)
  other_rules JSONB,
  
  -- Status & Metadata
  is_active BOOLEAN DEFAULT true,
  created_by UUID,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_by UUID,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT statutory_unique_per_tenant UNIQUE(tenant_id, config_name)
);

CREATE INDEX idx_statutory_config_tenant_id ON statutory_config(tenant_id);
CREATE INDEX idx_statutory_config_effective_date ON statutory_config(effective_date);

-- ============================================================================
-- AUDIT & LOGGING
-- ============================================================================

CREATE TABLE audit_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  
  -- Action Details
  entity_type VARCHAR(100) NOT NULL,  -- 'employee', 'attendance', 'payroll', etc.
  entity_id UUID NOT NULL,
  action VARCHAR(50) NOT NULL,  -- 'create', 'update', 'delete'
  
  -- Change Tracking
  old_values JSONB,
  new_values JSONB,
  
  -- User & Timestamp
  performed_by UUID REFERENCES employee_master(id),
  ip_address INET,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_log_tenant_id ON audit_log(tenant_id);
CREATE INDEX idx_audit_log_entity ON audit_log(entity_type, entity_id);
CREATE INDEX idx_audit_log_created_at ON audit_log(created_at);

-- ============================================================================
-- ROW LEVEL SECURITY (RLS)
-- ============================================================================

-- Enable RLS on all tables
ALTER TABLE tenants ENABLE ROW LEVEL SECURITY;
ALTER TABLE employee_master ENABLE ROW LEVEL SECURITY;
ALTER TABLE salary_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendance_ledger ENABLE ROW LEVEL SECURITY;
ALTER TABLE ewa_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE payroll_runs ENABLE ROW LEVEL SECURITY;
ALTER TABLE payroll_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE statutory_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_log ENABLE ROW LEVEL SECURITY;

-- RLS Policies for Tenants (Tenant owners only)
CREATE POLICY tenants_select ON tenants FOR SELECT
  USING (auth.uid()::uuid = id OR true);  -- Adjust based on your auth implementation

CREATE POLICY tenants_insert ON tenants FOR INSERT
  WITH CHECK (true);  -- Adjust based on your auth implementation

CREATE POLICY tenants_update ON tenants FOR UPDATE
  USING (auth.uid()::uuid = id);  -- Adjust based on your auth implementation

-- RLS Policies for Employee Master (Tenant isolation)
CREATE POLICY employee_master_select ON employee_master FOR SELECT
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY employee_master_insert ON employee_master FOR INSERT
  WITH CHECK (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY employee_master_update ON employee_master FOR UPDATE
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY employee_master_delete ON employee_master FOR DELETE
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

-- RLS Policies for Salary Config (Tenant isolation)
CREATE POLICY salary_config_select ON salary_config FOR SELECT
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY salary_config_insert ON salary_config FOR INSERT
  WITH CHECK (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY salary_config_update ON salary_config FOR UPDATE
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

-- RLS Policies for MP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_log_tenant_id ON audit_log(tenant_id);
CREATE INDEX idx_audit_log_entity ON audit_log(entity_type, entity_id);
CREATE INDEX idx_audit_log_created_at ON audit_log(created_at);

-- ============================================================================
-- ROW LEVEL SECURITY (RLS)
-- ============================================================================

-- Enable RLS on all tables
ALTER TABLE tenants ENABLE ROW LEVEL SECURITY;
ALTER TABLE employee_master ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendance_ledger ENABLE ROW LEVEL SECURITY;
ALTER TABLE ewa_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE payroll_runs ENABLE ROW LEVEL SECURITY;
ALTER TABLE payroll_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE statutory_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_log ENABLE ROW LEVEL SECURITY;

-- RLS Policies for Tenants (Tenant owners only)
CREATE POLICY tenants_select ON tenants FOR SELECT
  USING (auth.uid()::uuid = id OR true);  -- Adjust based on your auth implementation

CREATE POLICY tenants_insert ON tenants FOR INSERT
  WITH CHECK (true);  -- Adjust based on your auth implementation

CREATE POLICY tenants_update ON tenants FOR UPDATE
  USING (auth.uid()::uuid = id);  -- Adjust based on your auth implementation

-- RLS Policies for Employee Master (Tenant isolation)
CREATE POLICY employee_master_select ON employee_master FOR SELECT
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY employee_master_insert ON employee_master FOR INSERT
  WITH CHECK (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY employee_master_update ON employee_master FOR UPDATE
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY employee_master_delete ON employee_master FOR DELETE
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

-- RLS Policies for Attendance Ledger (Tenant isolation)
CREATE POLICY attendance_ledger_select ON attendance_ledger FOR SELECT
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY attendance_ledger_insert ON attendance_ledger FOR INSERT
  WITH CHECK (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY attendance_ledger_update ON attendance_ledger FOR UPDATE
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

-- RLS Policies for EWA Transactions (Tenant isolation)
CREATE POLICY ewa_transactions_select ON ewa_transactions FOR SELECT
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY ewa_transactions_insert ON ewa_transactions FOR INSERT
  WITH CHECK (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY ewa_transactions_update ON ewa_transactions FOR UPDATE
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

-- RLS Policies for Payroll Runs (Tenant isolation)
CREATE POLICY payroll_runs_select ON payroll_runs FOR SELECT
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY payroll_runs_insert ON payroll_runs FOR INSERT
  WITH CHECK (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY payroll_runs_update ON payroll_runs FOR UPDATE
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

-- RLS Policies for Payroll Items (Tenant isolation)
CREATE POLICY payroll_items_select ON payroll_items FOR SELECT
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY payroll_items_insert ON payroll_items FOR INSERT
  WITH CHECK (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY payroll_items_update ON payroll_items FOR UPDATE
  USING (salary_config_updated_at BEFORE UPDATE ON salary_config
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

-- RLS Policies for Statutory Config (Tenant isolation)
CREATE POLICY statutory_config_select ON statutory_config FOR SELECT
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY statutory_config_insert ON statutory_config FOR INSERT
  WITH CHECK (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY statutory_config_update ON statutory_config FOR UPDATE
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

-- RLS Policies for Audit Log (Tenant isolation)
CREATE POLICY audit_log_select ON audit_log FOR SELECT
  USING (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

CREATE POLICY audit_log_insert ON audit_log FOR INSERT
  WITH CHECK (
    tenant_id IN (
      SELECT id FROM tenants WHERE id = tenant_id
    )
  );

-- ============================================================================
-- HELPER FUNCTIONS
-- ============================================================================

-- Function to encrypt NRIC before insert/update
CREATE OR REPLACE FUNCTION encrypt_nric()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.nric IS NOT NULL THEN
    NEW.nric := pgcrypto.encrypt(
      encode(NEW.nric, 'escape'),
      'secret_key',
      'aes'
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ============================================================================
-- TRIGGERS
-- ============================================================================

-- Update updated_at for all tables
CREATE TRIGGER update_tenants_updated_at BEFORE UPDATE ON tenants
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_employee_master_updated_at BEFORE UPDATE ON employee_master
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_attendance_ledger_updated_at BEFORE UPDATE ON attendance_ledger
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_ewa_transactions_updated_at BEFORE UPDATE ON ewa_transactions
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_payroll_runs_updated_at BEFORE UPDATE ON payroll_runs
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_payroll_items_updated_at BEFORE UPDATE ON payroll_items
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_statutory_config_updated_at BEFORE UPDATE ON statutory_config
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- VIEWS FOR COMMON QUERIES
-- ============================================================================

-- View: Employee with current approval chain details
CREATE OR REPLACE VIEW employee_with_approvers AS
SELECT 
  em.id,
  em.tenant_id,
  em.employee_id,
  em.full_name,
  em.email,
  em.phone_number,
  em.department,
  em.designation,
  em.epf_status,
  em.approval_chain,
  em.is_active,
  em.created_at,
  em.updated_at
FROM employee_master em;

-- View: Payroll Run Summary
CREATE OR REPLACE VIEW payroll_run_summary AS
SELECT 
  pr.id,
  pr.tenant_id,
  pr.payroll_month,
  pr.status,
  COUNT(DISTINCT pi.employee_id) as employee_count,
  SUM(pi.gross_amount) as total_gross,
  SUM(pi.total_deductions) as total_deductions,
  SUM(pi.net_amount) as total_net,
  pr.created_at
FROM payroll_runs pr
LEFT JOIN payroll_items pi ON pr.id = pi.payroll_run_id
GROUP BY pr.id, pr.tenant_id, pr.payroll_month, pr.status, pr.created_at;

-- View: Attendance Summary by Employee
CREATE OR REPLACE VIEW attendance_summary AS
SELECT 
  employee_id,
  DATE_TRUNC('month', attendance_date)::date as month,
  COUNT(*) as total_days,
  SUM(working_hours) as total_hours,
  COUNT(*) FILTER (WHERE ot_approved_hours > 0) as ot_days,
  SUM(ot_approved_hours) as total_ot_hours
FROM attendance_ledger
WHERE attendance_date IS NOT NULL
GROUP BY employee_id, DATE_TRUNC('month', attendance_date);

-- ============================================================================
-- END OF SCHEMA
-- ============================================================================
